<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan Produit</title>

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Spline+Sans:wght@400;500;700"
    />

    <link rel="stylesheet" href="/src/style.css" />
  </head>
  <body class="bg-[#111714]">
    <main
      class="relative flex size-full min-h-screen flex-col bg-[#111714] text-white dark justify-between group/design-root overflow-x-hidden"
      style="font-family: 'Spline Sans', 'Noto Sans', sans-serif"
    >
      <!-- ... Ton code HTML pour le header, le corps et le footer reste identique ... -->
      <div>
        <header class="flex items-center bg-[#111714] p-4 pb-2 justify-between">
          <h2 class="flex-1 text-center pl-12 text-lg font-bold leading-tight tracking-[-0.015em]">Carrefour</h2>
          <div class="flex w-12 items-center justify-end">
            <button class="flex h-12 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-transparent p-0 text-white">
              <div data-icon="ShoppingCart" data-size="24px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M222.14,58.87A8,8,0,0,0,216,56H54.68L49.79,29.14A16,16,0,0,0,34.05,16H16a8,8,0,0,0,0,16h18L59.56,172.29a24,24,0,0,0,5.33,11.27,28,28,0,1,0,44.4,8.44h45.42A27.75,27.75,0,0,0,152,204a28,28,0,1,0,28-28H83.17a8,8,0,0,1-7.87-6.57L72.13,152h116a24,24,0,0,0,23.61-19.71l12.16-66.86A8,8,0,0,0,222.14,58.87ZM96,204a12,12,0,1,1-12-12A12,12,0,0,1,96,204Zm96,0a12,12,0,1,1-12-12A12,12,0,0,1,192,204Zm4-74.57A8,8,0,0,1,188.1,136H69.22L57.59,72H206.41Z"></path></svg>
              </div>
            </button>
          </div>
        </header>
        <h2 class="px-4 pb-3 pt-5 text-center text-[28px] font-bold leading-tight tracking-light">Scannez votre produit</h2>
        <p class="px-4 pb-3 pt-1 text-center text-base font-normal leading-normal">Dirigez votre caméra vers le code-barres du produit</p>
        <div class="flex justify-center px-4 py-3">
          <button id="scan-button" class="flex h-12 min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-full !bg-[#38e07b] px-5 pl-5 text-base font-bold leading-normal tracking-[0.015em] text-[#111714]">
            <div class="text-[#111714]" data-icon="Camera" data-size="24px" data-weight="regular"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M208,56H180.28L166.65,35.56A8,8,0,0,0,160,32H96a8,8,0,0,0-6.65,3.56L75.71,56H48A24,24,0,0,0,24,80V192a24,24,0,0,0,24,24H208a24,24,0,0,0,24-24V80A24,24,0,0,0,208,56Zm8,136a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V80a8,8,0,0,1,8-8H80a8,8,0,0,0,6.66-3.56L100.28,48h55.43l13.63,20.44A8,8,0,0,0,176,72h32a8,8,0,0,1,8,8ZM128,88a44,44,0,1,0,44,44A44.05,44.05,0,0,0,128,88Zm0,72a28,28,0,1,1,28-28A28,28,0,0,1,128,160Z"></path></svg></div>
            <span class="truncate">Numériser le produit</span>
          </button>
        </div>
      </div>
      <footer><!-- ... --></footer>
    </main>

    <!-- Vue de la caméra -->
    <div id="camera-container" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90">
      <div class="absolute z-10 w-3/4 max-w-sm h-1/4 border-4 border-dashed border-white/50 rounded-lg"></div>
      <p id="feedback-text" class="absolute top-10 z-10 text-white text-lg font-bold bg-black/50 p-2 rounded">Démarrage de la caméra...</p>
      <video id="camera-feed" class="h-full w-full object-cover" autoplay playsinline></video>
      <button id="stop-button" class="absolute bottom-10 z-10 rounded-full bg-red-600 px-6 py-3 font-bold text-white">Annuler</button>
    </div>

    <!-- NOUVELLE LOGIQUE : SIMULATION DE SCAN -->
    <script type="module">
      const scanButton = document.getElementById('scan-button');
      const stopButton = document.getElementById('stop-button');
      const cameraContainer = document.getElementById('camera-container');
      const cameraFeed = document.getElementById('camera-feed');
      const feedbackText = document.getElementById('feedback-text');

      let stream = null;
      let redirectTimer = null; // Variable pour le timer de redirection

      // Fonction pour arrêter proprement la caméra ET le timer
      const stopScan = () => {
        // Annule la redirection si l'utilisateur clique sur "Annuler"
        if (redirectTimer) {
          clearTimeout(redirectTimer);
          redirectTimer = null;
        }
        // Arrête le flux vidéo
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
        // Cache la vue de la caméra
        cameraContainer.classList.add('hidden');
      };

      // Au clic sur le bouton "Scan"
      scanButton.addEventListener('click', async () => {
        try {
          // Ouvre la caméra comme avant
          const constraints = { video: { facingMode: 'environment' } };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          cameraFeed.srcObject = stream;

          // Affiche la vue caméra et le message de feedback
          cameraContainer.classList.remove('hidden');
          feedbackText.textContent = "Numérisation en cours...";

          // Lance un timer de 3 secondes (3000 millisecondes)
          redirectTimer = setTimeout(() => {
            // Après 3 secondes, redirige vers la page produit
            window.location.href = '/produit.html';
          }, 3000);

        } catch (err) {
          console.error("Erreur d'accès à la caméra: ", err);
          alert("Impossible d'accéder à la caméra. Veuillez vérifier les autorisations.");
        }
      });

      // Le bouton "Cancel" arrête tout
      stopButton.addEventListener('click', stopScan);
    </script>
  </body>
</html>